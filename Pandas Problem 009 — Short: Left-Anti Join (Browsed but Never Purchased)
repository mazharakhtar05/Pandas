#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
Pandas Problem 009 — Short: Left-Anti Join (Browsed but Never Purchased)

Dataset (synthetic):
- web_sessions: user_id, ts, sessions
- orders: user_id, order_id, ts

Tasks
1) Find users who had ≥1 web session but 0 orders (left-anti join).
2) Compute their total sessions and list top 5 such users by sessions.
3) Compute simple retention metrics:
   - total_users, buyers, nonbuyers, buyer_rate (%).
Save: ./artifacts/nonbuyers.csv, ./artifacts/nonbuyers_top5.csv, ./artifacts/retention_summary.csv
"""

import pandas as pd
import numpy as np
from pathlib import Path

def make_data(seed=9):
    rng = np.random.default_rng(seed)
    users = [f"U{str(i).zfill(4)}" for i in range(1, 501)]
    # simulate web sessions (some users multiple rows)
    ws = pd.DataFrame({
        "user_id": rng.choice(users, size=2000, replace=True),
        "ts": pd.to_datetime("2024-10-01") + pd.to_timedelta(rng.integers(0, 60*24*30, 2000), unit="m"),
        "sessions": rng.integers(1, 3, 2000)
    })
    # orders subset (about 35% of users)
    buyer_ids = set(rng.choice(users, size=int(len(users)*0.35), replace=False))
    orders = pd.DataFrame({
        "user_id": list(rng.choice(list(buyer_ids), size=800, replace=True)),
        "order_id": np.arange(10001, 10001+800),
        "ts": pd.to_datetime("2024-10-01") + pd.to_timedelta(rng.integers(0, 60*24*30, 800), unit="m")
    })
    return ws, orders

def main():
    web, orders = make_data()
    # distinct user sets
    web_users = web[["user_id"]].drop_duplicates()
    buyers = orders[["user_id"]].drop_duplicates()

    # 1) Left-anti join: web users with no orders
    nonbuyers = web_users.merge(buyers, on="user_id", how="left", indicator=True)
    nonbuyers = nonbuyers[nonbuyers["_merge"] == "left_only"][["user_id"]]

    # 2) Total sessions for nonbuyers + top 5
    sess_non = (web.merge(nonbuyers, on="user_id")
                   .groupby("user_id", as_index=False)["sessions"].sum()
                   .sort_values("sessions", ascending=False))
    top5 = sess_non.head(5)

    # 3) Retention metrics
    total_users = web_users.shape[0]
    buyers_n = buyers.shape[0]
    nonbuyers_n = total_users - buyers_n
    buyer_rate = round(buyers_n / total_users * 100, 2)
    summary = pd.DataFrame([{
        "total_users": total_users,
        "buyers": buyers_n,
        "nonbuyers": nonbuyers_n,
        "buyer_rate_pct": buyer_rate
    }])

    # prints
    print("\nNon-buyers (count):", nonbuyers_n)
    print("\nTop 5 non-buyers by sessions:")
    print(top5.to_string(index=False))
    print("\nRetention summary:")
    print(summary.to_string(index=False))

    # save
    out = Path("artifacts"); out.mkdir(parents=True, exist_ok=True)
    sess_non.to_csv(out/"nonbuyers.csv", index=False)
    top5.to_csv(out/"nonbuyers_top5.csv", index=False)
    summary.to_csv(out/"retention_summary.csv", index=False)
    print("\nSaved to ./artifacts/")
    print("Done.")

if __name__ == "__main__":
    main()
